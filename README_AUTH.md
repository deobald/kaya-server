# Rails 8 Authentication with OAuth

This application implements user authentication using Rails 8's built-in authentication system with OAuth support for Google, Apple, and Microsoft.

## Features

- **Rails 8 Built-in Authentication**: Email/password authentication using Rails 8 generator
- **UUID Primary Keys**: Users table uses UUID (string-based) primary keys for better distributed system compatibility
- **Multi-Provider OAuth**: Support for Google, Apple, and Microsoft OAuth
- **Automatic User Creation**: OAuth users are automatically created with random passwords
- **Multiple OAuth Providers**: Users can link multiple OAuth providers to one account
- **Session Management**: Built-in session tracking with IP and user agent

## Database Schema

### Users (UUID Primary Key)
```ruby
id: string(36)              # UUID primary key
email_address: string       # Unique email
password_digest: string     # Optional (can be null for OAuth-only users)
created_at: datetime
updated_at: datetime
```

### Identities
```ruby
id: integer
user_id: string(36)         # Foreign key to users
provider: string            # 'google_oauth2', 'apple', 'microsoft_graph'
uid: string                 # Provider's unique identifier
created_at: datetime
updated_at: datetime

# Indexes
- index on user_id
- unique index on [provider, uid]
```

### Sessions
```ruby
id: integer
user_id: string(36)         # Foreign key to users
ip_address: string
user_agent: string
created_at: datetime
updated_at: datetime
```

## Authentication Workflows

### Email/Password Registration
1. User visits sign-up page (to be implemented)
2. Enters email and password
3. User record created with UUID
4. Session created and user logged in

### Email/Password Login
1. User visits `/session/new`
2. Enters email and password
3. Credentials verified via `has_secure_password`
4. Session created and user logged in

### OAuth Login (New User)
1. User clicks "Sign in with Google/Apple/Microsoft"
2. Redirected to OAuth provider
3. User authorizes the application
4. OAuth provider redirects back with auth data
5. System checks for existing Identity
6. If none found, checks for User with same email
7. Creates new User with random password
8. Creates Identity linking User to OAuth provider
9. Session created and user logged in

### OAuth Login (Existing User)
1. User clicks OAuth provider button
2. OAuth flow completes
3. System finds existing Identity
4. User logged in via existing account

### Linking Additional OAuth Provider
1. User already has account (email or Google)
2. Signs in with different OAuth provider (Microsoft)
3. System matches by email address
4. Creates new Identity for second provider
5. Both providers now linked to same User account

## Models

### User (`app/models/user.rb`)

```ruby
class User < ApplicationRecord
  # UUID generation
  before_create :generate_uuid
  
  # Authentication
  has_secure_password validations: false
  
  # Associations
  has_many :sessions, dependent: :destroy
  has_many :identities, dependent: :destroy
  
  # Validations
  validates :email_address, presence: true, uniqueness: true, format: URI::MailTo::EMAIL_REGEXP
  validates :password, presence: true, length: { minimum: 8 }, if: -> { password_digest.nil? || !password.nil? }
  
  # OAuth integration
  def self.from_omniauth(auth)
    # Finds or creates user from OAuth data
  end
end
```

### Identity (`app/models/identity.rb`)

```ruby
class Identity < ApplicationRecord
  belongs_to :user
  
  validates :provider, presence: true
  validates :uid, presence: true, uniqueness: { scope: :provider }
  validates :provider, inclusion: { in: %w[google_oauth2 apple microsoft_graph] }
end
```

## Controllers

### SessionsController
- Generated by Rails 8 authentication
- Handles email/password login
- Located at `app/controllers/sessions_controller.rb`

### OmniauthCallbacksController (`app/controllers/omniauth_callbacks_controller.rb`)
- Handles OAuth callbacks from all providers
- Creates users and sessions
- Route: `POST /auth/:provider/callback`

### PasswordsController
- Generated by Rails 8 authentication
- Handles password reset flow
- Located at `app/controllers/passwords_controller.rb`

## Routes

```ruby
# Rails 8 Authentication
resource :session
resources :passwords, param: :token

# OAuth
POST /auth/:provider/callback  # OAuth callback handler
GET  /auth/failure              # OAuth failure handler

# To initiate OAuth (from views)
POST /auth/google_oauth2        # Google login
POST /auth/apple                # Apple login
POST /auth/microsoft_graph      # Microsoft login
```

## Setup Instructions

1. **Install Dependencies**
   ```bash
   bundle install
   ```

2. **Setup Environment Variables**
   ```bash
   cp .env.example .env
   # Edit .env and add your OAuth credentials
   ```

3. **Run Migrations**
   ```bash
   bin/rails db:migrate
   ```

4. **Configure OAuth Providers**
   - See `OAUTH_SETUP.md` for detailed provider setup instructions

## Usage

### Sign In Page
Visit `/session/new` to see:
- Email/password login form
- OAuth provider buttons (Google, Apple, Microsoft)

### Creating a User Programmatically
```ruby
# Regular user
user = User.create!(
  email_address: "user@example.com",
  password: "securepassword123"
)

# OAuth user (happens automatically via OAuth flow)
# But can be done manually:
auth_hash = request.env['omniauth.auth']
user = User.from_omniauth(auth_hash)
```

## Security Features

- **Password Hashing**: BCrypt via `has_secure_password`
- **Random OAuth Passwords**: 64-character hex passwords for OAuth users
- **CSRF Protection**: OmniAuth configured with Rails CSRF protection
- **POST-only OAuth**: OAuth flows use POST instead of GET
- **Unique Constraints**: Database-level uniqueness on emails and OAuth identities
- **Session Tracking**: IP address and user agent logged for sessions

## Files Created/Modified

### New Files
- `app/models/identity.rb` - OAuth identity model
- `app/controllers/omniauth_callbacks_controller.rb` - OAuth callback handler
- `config/initializers/omniauth.rb` - OmniAuth configuration
- `config/initializers/sqlite_uuid.rb` - SQLite UUID support
- `.env.example` - Environment variable template
- `OAUTH_SETUP.md` - Detailed OAuth setup guide
- `db/migrate/*_create_identities.rb` - Identity table migration

### Modified Files
- `Gemfile` - Added OmniAuth gems
- `config/routes.rb` - Added OAuth routes
- `config/application.rb` - Configured UUID primary keys
- `app/models/user.rb` - Added OAuth support and UUID generation
- `app/views/sessions/new.html.erb` - Added OAuth login buttons
- `db/migrate/*_create_users.rb` - Modified for UUID primary key
- `db/migrate/*_create_sessions.rb` - Modified for UUID foreign key

## Testing

All functionality has been tested:
- ✓ UUID generation for new users
- ✓ Email/password authentication
- ✓ OAuth user creation with random passwords
- ✓ Linking multiple OAuth providers to one account
- ✓ Session creation with proper foreign keys

## Next Steps

To complete the authentication system, you may want to add:

1. **User Registration Page**: Create sign-up form for email/password users
2. **Account Settings**: Allow users to:
   - Link/unlink OAuth providers
   - Change password
   - View connected accounts
3. **Email Confirmation**: Add email verification flow
4. **Remember Me**: Extend session duration option
5. **Two-Factor Authentication**: Add 2FA support
6. **OAuth Profile Data**: Store additional user info from OAuth providers (name, avatar, etc.)

## Environment Variables Required

See `.env.example` for a complete list. Required variables:

```bash
# Google
GOOGLE_CLIENT_ID
GOOGLE_CLIENT_SECRET

# Apple
APPLE_CLIENT_ID
APPLE_TEAM_ID
APPLE_KEY_ID
APPLE_PRIVATE_KEY

# Microsoft
MICROSOFT_CLIENT_ID
MICROSOFT_CLIENT_SECRET
```

## Documentation

- `OAUTH_SETUP.md` - Complete OAuth provider setup guide
- `.env.example` - Environment variable template
- This file - Architecture and usage overview
